<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin â€” BayaniHomes</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>
</head>
<body>

    <!--Navbar-->
    <nav class = "navbar navbar-expand-lg bg-white border-bottom">
        <div class="container">
            <a class="navbar-brand fw-bold" href="index.html"><b>BayaniHomes</b></a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav">
            <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="mainNav">
                <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
                <li class="nav-item"><a href="listing.html" class="nav-link">Browse</a></li>
                <li class="nav-item"><a href="agents.html" class="nav-link">Agents</a></li>
                <li class="nav-item"><a href="dashboard.html" class="nav-link">My Account</a></li>
                <li class="nav-item"><a href="admin.html" class="nav-link">Admin</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <main class="row g-3">
        <div class="col-12">
            <div class="card">
                <div class="card-header fw-semibold">Properties</div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table align-middle">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Title</th>
                                    <th>City</th>
                                    <th>Type</th>
                                    <th>Status</th>
                                    <th>Price</th>
                                </tr>
                            </thead>
                            <tbody id="propTbody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!--Edit Modal-->
    
    <div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <form class="modal-content" onsubmit="event.preventDefault(); saveProperty();">
                <div class="modal-header">
                    <h5 class="modal-title">Property</h5>
                    <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <input type="hidden" id="f-id">
                    
                    <div class="row g-3">
                        <div class="col-md-8">
                            <label class="form-label">Title</label>
                            <input id="f-title" class="form-control" required>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label">City</label>
                            <input id="f-city" class="form-control" required>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label">Type</label>
                            <select id="f-type" class="form-select">
                                <option>House</option>
                                <option>Condo</option>
                                <option>Lot</option>
                            </select>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label">Status</label>
                            <select id="f-status" class="form-select">
                                <option>For Sale</option>
                                <option>For Rent</option>
                                <option>Sold</option>
                            </select>
                        </div>

                        <div class="col-md-4"><label class="form-label">Price</label><input id="f-price" type="number" class="form-control" required>
                        </div>

                        <div class="col-md-4"><label class="form-label">Beds</label><input id="f-beds" type="number" class="form-control" value="0">
                        </div>

                        <div class="col-md-4"><label class="form-label">Baths</label><input id="f-baths" type="number" class="form-control" value="1">
                        </div>

                        <div class="col-md-4"><label class="form-label">Area (sqm)</label><input id="f-area" type="number" class="form-control" value="24">
                        </div>

                        <div class="col-md-12"><label class="form-label">Thumbnail URL</label><input id="f-thumb" class="form-control">
                        </div>
                        
                        <div class="col-md-12"><label class="form-label">Description</label><textarea id="f-desc" class="form-control" rows="3"></textarea>
                        </div>

                        <div class="col-md-4"><label class="form-label">Agent</label><select id="f-agent" class="form-select"></select>
                        </div>

                        <div class="col-md-4 form-check ms-2 mt-4">
                            <input id="f-featured" class="form-check-input" type="checkbox"><label class="form-check-label" for="f-featured">Featured</label>
                        </div>
                    </div>
                </div>
                <div class="d-flex justify-content-center p-2">
                    <button class="btn btn-secondary m-2 px-4 py-2" data-bs-dismiss="modal">Close</button>
                    <button class="btn btn-primary m-2 px-4 py-2">Save</button>
                </div>
                </div>

            </form>
        </div>
    </div>

    <!-- FOOTER -->
    <footer class="border-top py-4 mt-5">
        <div class="container small text-muted d-flex flex-column flex-md-row gap-2 justify-content-between">
        <div>&copy; <span id="y"></span> BayaniHomes. All rights reserved.
        </div>
            <div class="d-flex gap-3">
                <a href="#" class="link-secondary">Privacy</a>
                <a href="#" class="link-secondary">Terms</a>
                <a href="#" class="link-secondary">Contact</a>
            </div>
        </div>
    </footer>

    <script src="/assets/js/data.js"></script>
    <script src="/assets/js/app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const STORAGE_KEY = 'adminProperties';
        const agentsSelect = document.getElementById('f-agent');

        function data(){ return store.get(STORAGE_KEY, PROPERTIES); }
        function saveData(arr){ store.set(STORAGE_KEY, arr); }

        function fillAgents(){
        agentsSelect.innerHTML = AGENTS.map(a=>`<option value="${a.id}">${a.name}</option>`).join('');
        }

        function renderTable(){
        const tbody = document.getElementById('propTbody');
        tbody.innerHTML = data().map(p=>`
            <tr>
            <td>${p.id}</td>
            <td>${p.title}</td>
            <td>${p.city}</td>
            <td>${p.type}</td>
            <td><span class="badge text-bg-${p.status==='For Sale'?'success':'info'}">${p.status}</span></td>
            <td>${formatMoney(p.price)}</td>
            <td class="table-actions text-end">
                <button class="btn btn-outline-secondary btn-sm" onclick="openEditor(${p.id})"><i class="bi bi-pencil"></i></button>
                <button class="btn btn-outline-danger btn-sm" onclick="delProperty(${p.id})"><i class="bi bi-trash"></i></button>
            </td>
            </tr>
        `).join('');
        }

        function openEditor(id){
        fillAgents();
        const formIds = ['id','title','city','type','status','price','beds','baths','area','thumb','desc','agent','featured'];
        const f = Object.fromEntries(formIds.map(k=>[k, document.getElementById('f-'+k)]));
        if(id){
            const p = data().find(x=>x.id===id);
            f.id.value = p.id; f.title.value = p.title; f.city.value = p.city; f.type.value = p.type;
            f.status.value = p.status; f.price.value = p.price; f.beds.value = p.beds; f.baths.value = p.baths;
            f.area.value = p.area; f.thumb.value = p.thumb; f.desc.value = p.description; f.agent.value = p.agentId;
            f.featured.checked = !!p.featured;
        } else {
            f.id.value = ''; f.title.value=''; f.city.value=''; f.type.value='House'; f.status.value='For Sale';
            f.price.value=''; f.beds.value='0'; f.baths.value='1'; f.area.value='24'; f.thumb.value=''; f.desc.value='';
            f.agent.value = AGENTS[0].id; f.featured.checked = false;
        }
        new bootstrap.Modal('#editModal').show();
        }

        function saveProperty(){
        const formIds = ['id','title','city','type','status','price','beds','baths','area','thumb','desc','agent','featured'];
        const f = Object.fromEntries(formIds.map(k=>[k, document.getElementById('f-'+k)]));
        let list = data();
        if(f.id.value){
            const i = list.findIndex(x=>x.id==f.id.value);
            list[i] = {...list[i],
            title:f.title.value, city:f.city.value, type:f.type.value, status:f.status.value,
            price:+f.price.value, beds:+f.beds.value, baths:+f.baths.value, area:+f.area.value,
            thumb:f.thumb.value||"https://placehold.co/600x400?text=New+Property",
            description:f.desc.value, agentId:+f.agent.value, featured:f.featured.checked
            };
        } else {
            const newId = Math.max(...list.map(x=>x.id))+1;
            list.push({
            id:newId, title:f.title.value, city:f.city.value, type:f.type.value, status:f.status.value,
            price:+f.price.value, beds:+f.beds.value, baths:+f.baths.value, area:+f.area.value,
            thumb:f.thumb.value||"https://placehold.co/600x400?text=New+Property",
            gallery:[f.thumb.value||"https://placehold.co/800x500?text=Gallery"],
            description:f.desc.value, agentId:+f.agent.value, featured:f.featured.checked
            });
        }
        saveData(list); renderTable(); bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
        }

        function delProperty(id){
        if(!confirm('Delete property?')) return;
        let list = data().filter(x=>x.id!==id);
        saveData(list); renderTable();
        }

        renderTable();
    </script>
    
</body>
</html>